<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Arbitrage Monkey || By Quantum Automata</title>
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/logos/favicon.png') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.min.css.map') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='scss/styles.scss') }}" />
  <style>
    /* Fix for overlapping sidebar and content */
    body {
      overflow-x: hidden;
    }
    
    .left-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 100;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    .body-wrapper {
      margin-left: 260px;
      min-height: 50vh;
      position: relative;
    }
    
    .app-header {
      position: sticky;
      top: 0;
      z-index: 99;
      background: #fff;
    }
    
    /* Ensure content doesn't overlap with sidebar */
    @media (max-width: 1199.98px) {
      .left-sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .left-sidebar.show {
        transform: translateX(0);
      }
      
      .body-wrapper {
        margin-left: 0;
      }
      
      .body-wrapper::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }
      
      .body-wrapper.sidebar-show::before {
        opacity: 1;
        visibility: visible;
      }
    }
    
    /* Fix for dropdown menus */
    .dropdown-menu {
      z-index: 1000;
    }
    
    /* Ensure content is properly spaced */
    .body-wrapper-inner {
      padding: 2px;
    }
  </style>
</head>

<body>
  <!-- Sidebar Start -->
  <aside class="left-sidebar">
    <!-- Sidebar scroll-->
    <div class="scroll-sidebar" data-simplebar>
      <div class="brand-logo d-flex align-items-center justify-content-between">
        <a href="{{ url_for('dashboard.index') }}" class="text-nowrap logo-img">
          <img src="{{ url_for('static', filename='images/logos/logo.svg') }}" alt="Logo" width="120" />
        </a>
        <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
          <i class="ti ti-x fs-8"></i>
        </div>
      </div>
      <!-- Sidebar navigation-->
      <nav class="sidebar-nav">
        <ul id="sidebarnav">
          <li class="nav-small-cap">
            <iconify-icon icon="solar:menu-dots-linear" class="nav-small-cap-icon fs-4"></iconify-icon>
            <span class="hide-menu">Home</span>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="{{ url_for('dashboard.index') }}" aria-expanded="false">
              <iconify-icon icon="solar:home-2-broken"></iconify-icon>
              <span class="hide-menu">Dashboard</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="{{ url_for ('dashboard.opportunities') }}" aria-expanded="false">

              <iconify-icon icon="solar:dollar-minimalistic-broken"></iconify-icon>
              <span class="hide-menu">Opportunities Hub</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="{{ url_for('dashboard.configure') }}" aria-expanded="false">
              <iconify-icon icon="solar:station-bold"></iconify-icon>
              <span class="hide-menu">Configure Scanner</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="{{ url_for ('dashboard.notification') }}" aria-expanded="false">
              <iconify-icon icon="solar:bell-bing-broken"></iconify-icon>
              <span class="hide-menu">Notification Settings</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="#" aria-expanded="false">
              <iconify-icon icon="solar:card-broken"></iconify-icon>
              <span class="hide-menu">Subscription</span>
            </a>
          </li>
          <!-- Additional menu items can be added here -->
        </ul>
      </nav>
      <!-- End Sidebar navigation -->
    </div>
    <!-- End Sidebar scroll-->
  </aside>
  <!--  Sidebar End -->
  
  <!--  Main wrapper -->
  <div class="body-wrapper">
    <!--  Header Start -->
    <header class="app-header">
      <nav class="navbar navbar-expand-lg navbar-light">
        <ul class="navbar-nav">
          <li class="nav-item d-block d-xl-none">
            <a class="nav-link sidebartoggler" id="headerCollapse" href="javascript:void(0)">
              <i class="ti ti-menu-2"></i>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link" href="javascript:void(0)" id="drop1" data-bs-toggle="dropdown" aria-expanded="false">
              <iconify-icon icon="solar:bell-linear" class="fs-6"></iconify-icon>
              <div class="notification bg-primary rounded-circle" id="notification-badge" style="display: none;"></div>
            </a>
            <div class="dropdown-menu dropdown-menu-animate-up" aria-labelledby="drop1" style="width: 350px;">
              <div class="message-body">
                <div class="d-flex align-items-center justify-content-between p-3 border-bottom">
                  <h6 class="mb-0">Notifications</h6>
                  <button class="btn btn-sm btn-outline-primary" onclick="markAllAsRead()">
                    <i class="ti ti-check"></i> Mark All Read
                  </button>
                </div>
                <div id="notification-list" class="notification-scroll" style="max-height: 300px; overflow-y: auto;">
                  <div class="text-center p-4 text-muted" id="no-notifications">
                    <i class="ti ti-bell-off fs-4 mb-2"></i>
                    <p class="mb-0">No notifications yet</p>
                    <small>Your notifications will appear here once your scanner starts finding opportunities.</small>
                  </div>
                </div>
                <div class="border-top p-2">
                  <a href="{{ url_for('dashboard.notification') }}" class="btn btn-sm btn-primary w-100">
                    <i class="ti ti-settings"></i> Notification Settings
                  </a>
                </div>
              </div>
            </div>
          </li>
        </ul>
        <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
          <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
            <li class="nav-item dropdown">
              <a class="nav-link" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="{{ url_for('static', filename='images/profile/user-1.jpg') }}" alt="Profile" width="35" height="35" class="rounded-circle">
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                <div class="message-body">
                  <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                    <i class="ti ti-user fs-6"></i>
                    <p class="mb-0 fs-3">My Profile</p>
                  </a>
                  <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                    <i class="ti ti-mail fs-6"></i>
                    <p class="mb-0 fs-3">My Account</p>
                  </a>
                  <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    
    <!-- Main Content -->
    <div class="container-fluid">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      {% block content %}{% endblock %}
    </div>

  <script src="{{ url_for ('static', filename='libs/jquery/dist/jquery.min.js') }}"></script>
  <script src="{{ url_for ('static', filename='libs/bootstrap/dist/js/bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for ('static', filename='js/sidebarmenu.js') }}"></script>
  <script src="{{ url_for ('static', filename='js/app.min.js') }}"></script>
  <script src="{{ url_for ('static', filename='libs/simplebar/dist/simplebar.js') }}"></script>
  <!-- solar icons -->
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  
  <!-- Notification System Script -->
  <script>
    let notifications = [];
    let unreadCount = 0;
    
    // Load notifications on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadNotifications();
      // Poll for new notifications every 30 seconds
      setInterval(loadNotifications, 30000);
    });
    
    function loadNotifications() {
      fetch('/dashboard/notification-history?limit=10')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            notifications = data.notifications;
            updateNotificationDisplay();
          }
        })
        .catch(error => console.error('Error loading notifications:', error));
    }
    
    function updateNotificationDisplay() {
      const notificationList = document.getElementById('notification-list');
      const notificationBadge = document.getElementById('notification-badge');
      const noNotifications = document.getElementById('no-notifications');
      
      // Count unread notifications
      unreadCount = notifications.filter(n => !n.read_at).length;
      
      // Update badge
      if (unreadCount > 0) {
        notificationBadge.style.display = 'block';
        notificationBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
      } else {
        notificationBadge.style.display = 'none';
      }
      
      // Update notification list
      if (notifications.length === 0) {
        noNotifications.style.display = 'block';
        return;
      }
      
      noNotifications.style.display = 'none';
      
      const notificationHTML = notifications.map(notification => {
        const isUnread = !notification.read_at;
        const timeAgo = formatTimeAgo(new Date(notification.created_at));
        const typeIcon = getNotificationIcon(notification.notification_type);
        
        return `
          <div class="dropdown-item notification-item ${isUnread ? 'unread' : ''}" 
               onclick="markAsRead('${notification.id}')" 
               style="cursor: pointer; ${isUnread ? 'background-color: #f8f9fa;' : ''}">
            <div class="d-flex align-items-start">
              <div class="me-3">
                <i class="${typeIcon} fs-5 ${isUnread ? 'text-primary' : 'text-muted'}"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1 ${isUnread ? 'fw-bold' : 'fw-normal'}">${notification.title}</h6>
                <p class="mb-1 text-muted small" style="word-wrap: break-word; white-space: normal; max-width: 280px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${notification.message}</p>
                <small class="text-muted">${timeAgo}</small>
              </div>
              ${isUnread ? '<div class="ms-2"><span class="badge bg-primary rounded-pill">New</span></div>' : ''}
            </div>
          </div>
        `;
      }).join('');
      
      notificationList.innerHTML = notificationHTML;
    }
    
    function getNotificationIcon(type) {
      switch(type) {
        case 'arbitrage_opportunity': return 'ti ti-trending-up';
        case 'price_alert': return 'ti ti-bell-ringing';
        case 'system_update': return 'ti ti-info-circle';
        case 'scanner_status': return 'ti ti-activity';
        default: return 'ti ti-bell';
      }
    }
    
    function formatTimeAgo(date) {
      const now = new Date();
      // Convert UTC date to local time for proper comparison
      const utcDate = new Date(date + 'Z'); // Add 'Z' to ensure it's treated as UTC
      const diffInSeconds = Math.floor((now - utcDate) / 1000);
      
      if (diffInSeconds < 60) return 'Just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
      return `${Math.floor(diffInSeconds / 86400)}d ago`;
    }
    
    function markAsRead(notificationId) {
      fetch(`/dashboard/notification-history`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'mark_read',
          notification_id: notificationId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update local notification status
          const notification = notifications.find(n => n.id === notificationId);
          if (notification) {
            notification.read_at = new Date().toISOString();
            updateNotificationDisplay();
          }
        }
      })
      .catch(error => console.error('Error marking notification as read:', error));
    }
    
    function markAllAsRead() {
      fetch(`/dashboard/notification-history`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'mark_all_read'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update all notifications as read
          notifications.forEach(n => {
            if (!n.read_at) {
              n.read_at = new Date().toISOString();
            }
          });
          updateNotificationDisplay();
        }
      })
      .catch(error => console.error('Error marking all notifications as read:', error));
    }
  </script>
  
  <script>
    // Toggle sidebar on mobile
    document.addEventListener('DOMContentLoaded', function() {
      const sidebarTogglers = document.querySelectorAll('.sidebartoggler');
      const sidebar = document.querySelector('.left-sidebar');
      const bodyWrapper = document.querySelector('.body-wrapper');
      
      sidebarTogglers.forEach(toggler => {
        toggler.addEventListener('click', function() {
          sidebar.classList.toggle('show');
          bodyWrapper.classList.toggle('sidebar-show');
        });
      });
      
      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', function(event) {
        if (window.innerWidth < 1200 && 
            !sidebar.contains(event.target) && 
            !event.target.matches('.sidebartoggler') && 
            !event.target.closest('.sidebartoggler')) {
          sidebar.classList.remove('show');
          bodyWrapper.classList.remove('sidebar-show');
        }
      });
    });
  </script>
</body>

</html>


